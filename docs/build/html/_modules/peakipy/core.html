
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>peakipy.core &#8212; peakipy 0.1.16 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for peakipy.core</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; </span>

<span class="sd">    peakipy - deconvolute overlapping NMR peaks</span>
<span class="sd">    Copyright (C) 2019  Jacob Peter Brady</span>

<span class="sd">    This program is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    This program is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>


<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">nmrglue</span> <span class="k">as</span> <span class="nn">ng</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">Fore</span><span class="p">,</span> <span class="n">init</span>

<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">finfo</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">lmfit.model</span> <span class="kn">import</span> <span class="n">ModelResult</span>
<span class="kn">from</span> <span class="nn">lmfit.models</span> <span class="kn">import</span> <span class="n">LinearModel</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">wofz</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>
<span class="kn">from</span> <span class="nn">matplotlib.widgets</span> <span class="kn">import</span> <span class="n">Button</span>

<span class="kn">from</span> <span class="nn">bokeh.palettes</span> <span class="kn">import</span> <span class="n">Category20</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">square</span><span class="p">,</span> <span class="n">binary_closing</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">rectangle</span>
<span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="kn">import</span> <span class="n">threshold_otsu</span>

<span class="n">init</span><span class="p">(</span><span class="n">autoreset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># constants</span>
<span class="n">log2</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">π</span> <span class="o">=</span> <span class="n">pi</span>
<span class="n">tiny</span> <span class="o">=</span> <span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>


<div class="viewcode-block" id="gaussian"><a class="viewcode-back" href="../../usage/code.html#peakipy.core.gaussian">[docs]</a><span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 1-dimensional Gaussian function.</span>

<span class="sd">        gaussian(x, center, sigma) = </span>
<span class="sd">            (1/(s2pi*sigma)) * exp(-(1.0*x-center)**2 / (2*sigma**2))</span>
<span class="sd">        </span>
<span class="sd">        :math:`\\frac{1}{ \sqrt{2\pi} } exp \left( \\frac{-(x-center)^2}{2 \sigma^2} \\right)`</span>
<span class="sd">        </span>
<span class="sd">        :param x: x</span>
<span class="sd">        :param center: center</span>
<span class="sd">        :param sigma: sigma</span>
<span class="sd">        :type x: numpy.array</span>
<span class="sd">        :type center: float</span>
<span class="sd">        :type sigma: float</span>

<span class="sd">        :return: 1-dimensional Gaussian</span>
<span class="sd">        :rtype: numpy.array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">tiny</span><span class="p">,</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">π</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)))</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span>
        <span class="o">-</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">tiny</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="lorentzian"><a class="viewcode-back" href="../../usage/code.html#peakipy.core.lorentzian">[docs]</a><span class="k">def</span> <span class="nf">lorentzian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 1-dimensional Lorentzian function.</span>

<span class="sd">        lorentzian(x, center, sigma) =</span>
<span class="sd">            (1/(1 + ((1.0*x-center)/sigma)**2)) / (pi*sigma)</span>

<span class="sd">        :math:`\\frac{1}{ 1+ \left( \\frac{x-center}{\sigma}\\right)^2} / (\pi\sigma)`</span>

<span class="sd">        :param x: x</span>
<span class="sd">        :param center: center</span>
<span class="sd">        :param sigma: sigma</span>
<span class="sd">        :type x: numpy.array</span>
<span class="sd">        :type center: float</span>
<span class="sd">        :type sigma: float</span>

<span class="sd">        :return: 1-dimensional Lorenztian </span>
<span class="sd">        :rtype: numpy.array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">tiny</span><span class="p">,</span> <span class="n">sigma</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span>
        <span class="n">tiny</span><span class="p">,</span> <span class="p">(</span><span class="n">π</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="voigt"><a class="viewcode-back" href="../../usage/code.html#peakipy.core.voigt">[docs]</a><span class="k">def</span> <span class="nf">voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a 1-dimensional Voigt function.</span>

<span class="sd">    voigt(x, center, sigma, gamma) =</span>
<span class="sd">        amplitude*wofz(z).real / (sigma*sqrt(2.0 * π))</span>

<span class="sd">    :math:`V(x,\sigma,\gamma) = (\\frac{Re[\omega(z)]}{\sigma \sqrt{2\pi}})`</span>

<span class="sd">    :math:`z=\\frac{x+i\gamma}{\sigma\sqrt{2}}`</span>

<span class="sd">    see Voigt_ wiki</span>

<span class="sd">    .. _Voigt: https://en.wikipedia.org/wiki/Voigt_profile</span>


<span class="sd">    :param x: x values</span>
<span class="sd">    :type x: numpy array 1d</span>
<span class="sd">    :param center: center of lineshape in points</span>
<span class="sd">    :type center: float</span>
<span class="sd">    :param sigma: sigma of gaussian</span>
<span class="sd">    :type sigma: float</span>
<span class="sd">    :param gamma: gamma of lorentzian</span>
<span class="sd">    :type gamma: float</span>

<span class="sd">    :returns: Voigt lineshape</span>
<span class="sd">    :rtype: numpy.array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gamma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">sigma</span>

    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">center</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">tiny</span><span class="p">,</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">wofz</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">real</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">tiny</span><span class="p">,</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">π</span><span class="p">)))</span></div>


<div class="viewcode-block" id="pseudo_voigt"><a class="viewcode-back" href="../../usage/code.html#peakipy.core.pseudo_voigt">[docs]</a><span class="k">def</span> <span class="nf">pseudo_voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 1-dimensional Pseudo-voigt function</span>
<span class="sd">    </span>
<span class="sd">        Superposition of Gaussian and Lorentzian function</span>

<span class="sd">        :math:`(1-\phi) G(x,center,\sigma_g) + \phi L(x, center, \sigma)`</span>

<span class="sd">        Where :math:`\phi` is the fraction of Lorentzian lineshape and :math:`G` and :math:`L` are Gaussian and</span>
<span class="sd">        Lorentzian functions, respectively.</span>

<span class="sd">        :param x: data</span>
<span class="sd">        :type x: numpy.array</span>
<span class="sd">        :param center: center of peak</span>
<span class="sd">        :type center: float</span>
<span class="sd">        :param sigma: sigma of lineshape</span>
<span class="sd">        :type sigma: float</span>
<span class="sd">        :param fraction: fraction of lorentzian lineshape (between 0 and 1)</span>
<span class="sd">        :type fraction: float</span>

<span class="sd">        :return: pseudo-voigt function</span>
<span class="sd">        :rtype: numpy.array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sigma_g</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">log2</span><span class="p">)</span>
    <span class="n">pv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fraction</span><span class="p">)</span> <span class="o">*</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">sigma_g</span><span class="p">)</span> <span class="o">+</span> <span class="n">fraction</span> <span class="o">*</span> <span class="n">lorentzian</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">sigma</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">pv</span></div>


<div class="viewcode-block" id="pvoigt2d"><a class="viewcode-back" href="../../usage/code.html#peakipy.core.pvoigt2d">[docs]</a><span class="k">def</span> <span class="nf">pvoigt2d</span><span class="p">(</span>
    <span class="n">XY</span><span class="p">,</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">center_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">center_y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">sigma_x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">sigma_y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 2D pseudo-voigt model</span>

<span class="sd">        :math:`(1-fraction) G(x,center,\sigma_{gx}) + (fraction) L(x, center, \sigma_x) * (1-fraction) G(y,center,\sigma_{gy}) + (fraction) L(y, center, \sigma_y)`</span>

<span class="sd">        :param XY: meshgrid of X and Y coordinates [X,Y] each with shape Z</span>
<span class="sd">        :type XY: numpy.array</span>

<span class="sd">        :param amplitude: amplitude of peak</span>
<span class="sd">        :type amplitude: float</span>

<span class="sd">        :param center_x: center of peak in x</span>
<span class="sd">        :type center_x: float</span>

<span class="sd">        :param center_y: center of peak in x</span>
<span class="sd">        :type center_y: float</span>

<span class="sd">        :param sigma_x: sigma of lineshape in x</span>
<span class="sd">        :type sigma_x: float</span>

<span class="sd">        :param sigma_y: sigma of lineshape in y</span>
<span class="sd">        :type sigma_y: float</span>

<span class="sd">        :param fraction: fraction of lorentzian lineshape (between 0 and 1)</span>
<span class="sd">        :type fraction: float</span>

<span class="sd">        :return: flattened array of Z values (use Z.reshape(X.shape) for recovery)</span>
<span class="sd">        :rtype: numpy.array</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">XY</span>
    <span class="c1"># sigma_gx = sigma_x / sqrt(2 * log2)</span>
    <span class="c1"># sigma_gy = sigma_y / sqrt(2 * log2)</span>
    <span class="c1"># fraction same for both dimensions</span>
    <span class="c1"># super position of gaussian and lorentzian</span>
    <span class="c1"># then convoluted for x y</span>
    <span class="c1"># pv_x = (1 - fraction) * gaussian(x, center_x, sigma_gx) + fraction * lorentzian(</span>
    <span class="c1">#    x, center_x, sigma_x</span>
    <span class="c1"># )</span>
    <span class="n">pv_x</span> <span class="o">=</span> <span class="n">pseudo_voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">fraction</span><span class="p">)</span>
    <span class="n">pv_y</span> <span class="o">=</span> <span class="n">pseudo_voigt</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">fraction</span><span class="p">)</span>
    <span class="c1"># pv_y = (1 - fraction) * gaussian(y, center_y, sigma_gy) + fraction * lorentzian(</span>
    <span class="c1">#    y, center_y, sigma_y</span>
    <span class="c1"># )</span>
    <span class="k">return</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">pv_x</span> <span class="o">*</span> <span class="n">pv_y</span></div>


<span class="k">def</span> <span class="nf">pv_l</span><span class="p">(</span>
    <span class="n">XY</span><span class="p">,</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">center_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">center_y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">sigma_x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">sigma_y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 2D lineshape model with pseudo-voigt in x and lorentzian in y</span>

<span class="sd">        Arguments</span>
<span class="sd">        =========</span>

<span class="sd">            -- XY: meshgrid of X and Y coordinates [X,Y] each with shape Z</span>
<span class="sd">            -- amplitude: peak amplitude (gaussian and lorentzian)</span>
<span class="sd">            -- center_x: position of peak in x</span>
<span class="sd">            -- center_y: position of peak in y</span>
<span class="sd">            -- sigma_x: linewidth in x</span>
<span class="sd">            -- sigma_y: linewidth in y</span>
<span class="sd">            -- fraction: fraction of lorentzian in fit</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>

<span class="sd">            -- flattened array of Z values (use Z.reshape(X.shape) for recovery)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">XY</span>
    <span class="n">pv_x</span> <span class="o">=</span> <span class="n">pseudo_voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">fraction</span><span class="p">)</span>
    <span class="n">pv_y</span> <span class="o">=</span> <span class="n">pseudo_voigt</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># lorentzian</span>
    <span class="k">return</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">pv_x</span> <span class="o">*</span> <span class="n">pv_y</span>


<span class="k">def</span> <span class="nf">pv_g</span><span class="p">(</span>
    <span class="n">XY</span><span class="p">,</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">center_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">center_y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">sigma_x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">sigma_y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 2D lineshape model with pseudo-voigt in x and gaussian in y</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>

<span class="sd">            -- XY: meshgrid of X and Y coordinates [X,Y] each with shape Z</span>
<span class="sd">            -- amplitude: peak amplitude (gaussian and lorentzian)</span>
<span class="sd">            -- center_x: position of peak in x</span>
<span class="sd">            -- center_y: position of peak in y</span>
<span class="sd">            -- sigma_x: linewidth in x</span>
<span class="sd">            -- sigma_y: linewidth in y</span>
<span class="sd">            -- fraction: fraction of lorentzian in fit</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">            -- flattened array of Z values (use Z.reshape(X.shape) for recovery)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">XY</span>
    <span class="n">pv_x</span> <span class="o">=</span> <span class="n">pseudo_voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">fraction</span><span class="p">)</span>
    <span class="n">pv_y</span> <span class="o">=</span> <span class="n">pseudo_voigt</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># gaussian</span>
    <span class="k">return</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">pv_x</span> <span class="o">*</span> <span class="n">pv_y</span>


<span class="k">def</span> <span class="nf">pv_pv</span><span class="p">(</span>
    <span class="n">XY</span><span class="p">,</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">center_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">center_y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">sigma_x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">sigma_y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">fraction_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">fraction_y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 2D lineshape model with pseudo-voigt in x and pseudo-voigt in y</span>
<span class="sd">        i.e. fraction_x and fraction_y params</span>

<span class="sd">        Arguments</span>
<span class="sd">        =========</span>

<span class="sd">            -- XY: meshgrid of X and Y coordinates [X,Y] each with shape Z</span>
<span class="sd">            -- amplitude: peak amplitude (gaussian and lorentzian)</span>
<span class="sd">            -- center_x: position of peak in x</span>
<span class="sd">            -- center_y: position of peak in y</span>
<span class="sd">            -- sigma_x: linewidth in x</span>
<span class="sd">            -- sigma_y: linewidth in y</span>
<span class="sd">            -- fraction_x: fraction of lorentzian in x</span>
<span class="sd">            -- fraction_y: fraction of lorentzian in y</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>

<span class="sd">            -- flattened array of Z values (use Z.reshape(X.shape) for recovery)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">XY</span>
    <span class="n">pv_x</span> <span class="o">=</span> <span class="n">pseudo_voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">fraction_x</span><span class="p">)</span>
    <span class="n">pv_y</span> <span class="o">=</span> <span class="n">pseudo_voigt</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">fraction_y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">pv_x</span> <span class="o">*</span> <span class="n">pv_y</span>


<span class="k">def</span> <span class="nf">gaussian_lorentzian</span><span class="p">(</span>
    <span class="n">XY</span><span class="p">,</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">center_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">center_y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">sigma_x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">sigma_y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 2D lineshape model with gaussian in x and lorentzian in y</span>

<span class="sd">        Arguments</span>
<span class="sd">        =========</span>

<span class="sd">            -- XY: meshgrid of X and Y coordinates [X,Y] each with shape Z</span>
<span class="sd">            -- amplitude: peak amplitude (gaussian and lorentzian)</span>
<span class="sd">            -- center_x: position of peak in x</span>
<span class="sd">            -- center_y: position of peak in y</span>
<span class="sd">            -- sigma_x: linewidth in x</span>
<span class="sd">            -- sigma_y: linewidth in y</span>
<span class="sd">            -- fraction: fraction of lorentzian in fit</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>

<span class="sd">            -- flattened array of Z values (use Z.reshape(X.shape) for recovery)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">XY</span>
    <span class="n">pv_x</span> <span class="o">=</span> <span class="n">pseudo_voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># gaussian</span>
    <span class="n">pv_y</span> <span class="o">=</span> <span class="n">pseudo_voigt</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># lorentzian</span>
    <span class="k">return</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">pv_x</span> <span class="o">*</span> <span class="n">pv_y</span>


<span class="k">def</span> <span class="nf">voigt2d</span><span class="p">(</span>
    <span class="n">XY</span><span class="p">,</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">center_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">center_y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">sigma_x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">sigma_y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">gamma_x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">gamma_y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">fraction</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">gamma_x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gamma_y</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">XY</span>
    <span class="n">voigt_x</span> <span class="o">=</span> <span class="n">voigt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">gamma_x</span><span class="p">)</span>
    <span class="n">voigt_y</span> <span class="o">=</span> <span class="n">voigt</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">gamma_y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">voigt_x</span> <span class="o">*</span> <span class="n">voigt_y</span>


<div class="viewcode-block" id="make_mask"><a class="viewcode-back" href="../../usage/code.html#peakipy.core.make_mask">[docs]</a><span class="k">def</span> <span class="nf">make_mask</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">c_x</span><span class="p">,</span> <span class="n">c_y</span><span class="p">,</span> <span class="n">r_x</span><span class="p">,</span> <span class="n">r_y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create and elliptical mask</span>

<span class="sd">        Generate an elliptical boolean mask with center c_x/c_y in points</span>
<span class="sd">        with radii r_x and r_y. Used to generate fit mask</span>

<span class="sd">        :param data: 2D array</span>
<span class="sd">        :type data: np.array</span>

<span class="sd">        :param c_x: x center</span>
<span class="sd">        :type c_x: float</span>

<span class="sd">        :param c_y: y center</span>
<span class="sd">        :type c_y: float</span>

<span class="sd">        :param r_x: radius in x</span>
<span class="sd">        :type r_x: float</span>

<span class="sd">        :param r_y: radius in y</span>
<span class="sd">        :type r_y: float</span>

<span class="sd">        :return: boolean mask of data.shape</span>
<span class="sd">        :rtype: numpy.array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c_y</span><span class="p">,</span> <span class="n">c_x</span>
    <span class="n">n_y</span><span class="p">,</span> <span class="n">n_x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[</span><span class="o">-</span><span class="n">a</span> <span class="p">:</span> <span class="n">n_y</span> <span class="o">-</span> <span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span> <span class="p">:</span> <span class="n">n_x</span> <span class="o">-</span> <span class="n">b</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">x</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">r_x</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">y</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">r_y</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">&lt;=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">mask</span></div>


<span class="k">def</span> <span class="nf">rmsd</span><span class="p">(</span><span class="n">residuals</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">residuals</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">residuals</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">fix_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">to_fix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Set parameters to fix</span>

<span class="sd">         </span>
<span class="sd">        :param params: lmfit parameters</span>
<span class="sd">        :type params: lmfit.Parameters</span>

<span class="sd">        :param to_fix: list of parameter name to fix</span>
<span class="sd">        :type to_fix: list</span>

<span class="sd">        :return: updated parameter object</span>
<span class="sd">        :rtype: lmfit.Parameters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">to_fix</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">params</span>


<span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ps_err</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">ps_err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ps</span><span class="p">,</span> <span class="n">ps_err</span><span class="p">,</span> <span class="n">names</span>


<span class="k">def</span> <span class="nf">make_param_dict</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lineshape</span><span class="o">=</span><span class="s2">&quot;PV&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Make dict of parameter names using prefix &quot;&quot;&quot;</span>

    <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

        <span class="n">str_form</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">to_prefix</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">ASS</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># using exact value of points (i.e decimal)</span>
        <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;center_x&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">X_AXISf</span>
        <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;center_y&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">Y_AXISf</span>
        <span class="c1"># estimate peak volume</span>
        <span class="n">amplitude_est</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">Y_AXIS</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">YW</span><span class="p">)</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">Y_AXIS</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">YW</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">X_AXIS</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">XW</span><span class="p">)</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">X_AXIS</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">XW</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;amplitude&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">amplitude_est</span>

        <span class="k">if</span> <span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;V&quot;</span><span class="p">:</span>
            <span class="c1">#  Voigt G sigma from linewidth esimate</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;sigma_x&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">XW</span> <span class="o">/</span> <span class="p">(</span>
                <span class="mf">2.0</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">log2</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># 3.6013</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;sigma_y&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">YW</span> <span class="o">/</span> <span class="p">(</span>
                <span class="mf">2.0</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">log2</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># 3.6013</span>
            <span class="c1">#  Voigt L gamma from linewidth esimate</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;gamma_x&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">XW</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;gamma_y&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">YW</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="c1"># height</span>
            <span class="c1"># add height here</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># sigma linewidth esimate</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;sigma_x&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">XW</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;sigma_y&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">YW</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="k">if</span> <span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;fraction&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">elif</span> <span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;fraction&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;PV_PV&quot;</span><span class="p">:</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;fraction_x&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;fraction_y&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">str_form</span><span class="p">(</span><span class="s2">&quot;fraction&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="k">return</span> <span class="n">param_dict</span>


<span class="k">def</span> <span class="nf">to_prefix</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Peak assignments with characters that are not compatible lmfit model naming</span>
<span class="sd">    are converted to lmfit &quot;safe&quot; names.</span>

<span class="sd">    :param x: Peak assignment to be used as prefix for lmfit model</span>
<span class="sd">    :type x: str</span>

<span class="sd">    :returns: lmfit model prefix (_Peak_assignment_)</span>
<span class="sd">    :rtype: str</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># must be string</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">x</span>
    <span class="n">to_replace</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;maybe&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">to_replace</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span>


<div class="viewcode-block" id="make_models"><a class="viewcode-back" href="../../usage/code.html#peakipy.core.make_models">[docs]</a><span class="k">def</span> <span class="nf">make_models</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lineshape</span><span class="o">=</span><span class="s2">&quot;PV&quot;</span><span class="p">,</span> <span class="n">xy_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Make composite models for multiple peaks</span>

<span class="sd">        :param model: lineshape function</span>
<span class="sd">        :type model: function</span>

<span class="sd">        :param peaks: instance of pandas.df.groupby(&quot;CLUSTID&quot;)</span>
<span class="sd">        :type peaks: pandas.df.groupby(&quot;CLUSTID&quot;)</span>

<span class="sd">        :param data: NMR data</span>
<span class="sd">        :type data: numpy.array</span>

<span class="sd">        :param lineshape: lineshape to use for fit (PV/G/L/PV_PV)</span>
<span class="sd">        :type lineshape: str</span>

<span class="sd">        :param xy_bounds: bounds for peak centers (+/-x, +/-y)</span>
<span class="sd">        :type xy_bounds: tuple</span>

<span class="sd">        :return mod: Composite lmfit model containing all peaks</span>
<span class="sd">        :rtype mod: lmfit.CompositeModel</span>

<span class="sd">        :return p_guess: params for composite model with starting values</span>
<span class="sd">        :rtype p_guess: lmfit.Parameters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># make model for first peak</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">to_prefix</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">ASS</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="c1"># add parameters</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="n">make_param_dict</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lineshape</span><span class="o">=</span><span class="n">lineshape</span><span class="p">)</span>
        <span class="n">p_guess</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span><span class="o">**</span><span class="n">param_dict</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># make model for first peak</span>
        <span class="n">first_peak</span><span class="p">,</span> <span class="o">*</span><span class="n">remaining_peaks</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">to_prefix</span><span class="p">(</span><span class="n">first_peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ASS</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">remaining_peaks</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">+=</span> <span class="n">Model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">to_prefix</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">ASS</span><span class="p">))</span>

        <span class="n">param_dict</span> <span class="o">=</span> <span class="n">make_param_dict</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lineshape</span><span class="o">=</span><span class="n">lineshape</span><span class="p">)</span>
        <span class="n">p_guess</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span><span class="o">**</span><span class="n">param_dict</span><span class="p">)</span>
        <span class="c1"># add Peak params to p_guess</span>

    <span class="n">update_params</span><span class="p">(</span><span class="n">p_guess</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">,</span> <span class="n">lineshape</span><span class="o">=</span><span class="n">lineshape</span><span class="p">,</span> <span class="n">xy_bounds</span><span class="o">=</span><span class="n">xy_bounds</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mod</span><span class="p">,</span> <span class="n">p_guess</span></div>


<div class="viewcode-block" id="update_params"><a class="viewcode-back" href="../../usage/code.html#peakipy.core.update_params">[docs]</a><span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">,</span> <span class="n">lineshape</span><span class="o">=</span><span class="s2">&quot;PV&quot;</span><span class="p">,</span> <span class="n">xy_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Update lmfit parameters with values from Peak</span>

<span class="sd">        :param params: lmfit parameters </span>
<span class="sd">        :type params: lmfit.Parameters object</span>
<span class="sd">        :param param_dict: parameters corresponding to each peak in fit</span>
<span class="sd">        :type param_dict: dict</span>
<span class="sd">        :param lineshape: lineshape (PV, G, L, PV_PV etc.)</span>
<span class="sd">        :type lineshape: str</span>
<span class="sd">        :param xy_bounds: bounds on xy peak positions</span>
<span class="sd">        :type xy_bounds: tuple</span>

<span class="sd">        :returns: None</span>
<span class="sd">        :rtype: None</span>

<span class="sd">        ToDo</span>
<span class="sd">          -- deal with boundaries</span>
<span class="sd">          -- currently positions in points</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c1"># print(&quot;update&quot;, k, v)</span>
        <span class="k">if</span> <span class="s2">&quot;center&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xy_bounds</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># no bounds set</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;center_x&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="c1"># set x bounds</span>
                    <span class="n">x_bound</span> <span class="o">=</span> <span class="n">xy_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">x_bound</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">x_bound</span>
                <span class="k">elif</span> <span class="s2">&quot;center_y&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="c1"># set y bounds</span>
                    <span class="n">y_bound</span> <span class="o">=</span> <span class="n">xy_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">y_bound</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">y_bound</span>
                <span class="c1"># pass</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;setting limit of </span><span class="si">%s</span><span class="s2">, min = </span><span class="si">%.3e</span><span class="s2">, max = </span><span class="si">%.3e</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;sigma&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="mf">1e4</span>

        <span class="k">elif</span> <span class="s2">&quot;gamma&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="mf">1e4</span>
            <span class="c1"># print(</span>
            <span class="c1">#    &quot;setting limit of %s, min = %.3e, max = %.3e&quot;</span>
            <span class="c1">#    % (k, params[k].min, params[k].max)</span>
            <span class="c1"># )</span>
        <span class="k">elif</span> <span class="s2">&quot;fraction&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="c1"># fix weighting between 0 and 1</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1">#  fix fraction of G or L</span>
            <span class="k">if</span> <span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="c1"># return params</span>


<span class="k">def</span> <span class="nf">run_log</span><span class="p">(</span><span class="n">log_name</span><span class="o">=</span><span class="s2">&quot;run_log.txt&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write log file containing time script was run and with which arguments&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_name</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">sys_argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
        <span class="n">sys_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">sys_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">name</span>
        <span class="n">run_args</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys_argv</span><span class="p">)</span>
        <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time_stamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%A </span><span class="si">%d</span><span class="s2"> %B %Y at %H:%M&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# Script run on </span><span class="si">{</span><span class="n">time_stamp</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">run_args</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="fit_first_plane"><a class="viewcode-back" href="../../usage/code.html#peakipy.core.fit_first_plane">[docs]</a><span class="k">def</span> <span class="nf">fit_first_plane</span><span class="p">(</span>
    <span class="n">group</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">uc_dics</span><span class="p">,</span>
    <span class="n">lineshape</span><span class="o">=</span><span class="s2">&quot;PV&quot;</span><span class="p">,</span>
    <span class="n">xy_bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">noise</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">fit_method</span><span class="o">=</span><span class="s2">&quot;leastsq&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Deconvolute group of peaks</span>

<span class="sd">        :param group: pandas data from containing group of peaks using groupby(&quot;CLUSTID&quot;)</span>
<span class="sd">        :type group: pandas.core.groupby.generic.DataFrameGroupBy</span>

<span class="sd">        :param data: NMR data</span>
<span class="sd">        :type data: numpy.array</span>

<span class="sd">        :param uc_dics: nmrglue unit conversion dics {&quot;f1&quot;:uc_f1,&quot;f2&quot;:uc_f2}</span>
<span class="sd">        :type uc_dics: dict</span>
<span class="sd">        </span>
<span class="sd">        :param lineshape: lineshape to fit (PV, G, L, V, G_L, PV_L, PV_G or PV_PV)</span>
<span class="sd">        :type lineshape: str</span>

<span class="sd">        :param xy_bounds: set bounds on x y positions. None or (x_bound, y_bound)</span>
<span class="sd">        :type xy_bounds: tuple</span>

<span class="sd">        :param plot: dir to save wireframe plots</span>
<span class="sd">        :type plot: str</span>

<span class="sd">        :param show: interactive matplotlib plot</span>
<span class="sd">        :type show: bool</span>

<span class="sd">        :param verbose: print what is happening to terminal</span>
<span class="sd">        :type verbose: bool</span>

<span class="sd">        :param log: file</span>
<span class="sd">        :type log: str</span>

<span class="sd">        :param noise: estimate of spectral noise for calculation of :math:`\chi^2` and :math:`\chi^2_{red}`</span>
<span class="sd">        :type noise: float</span>

<span class="sd">        :param fit_method: method used by lmfit</span>
<span class="sd">        :type fit_method: str</span>

<span class="sd">        :return: FitResult</span>
<span class="sd">        :rtype: FitResult</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;PV&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;G&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">):</span>
        <span class="n">mod</span><span class="p">,</span> <span class="n">p_guess</span> <span class="o">=</span> <span class="n">make_models</span><span class="p">(</span>
            <span class="n">pvoigt2d</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lineshape</span><span class="o">=</span><span class="n">lineshape</span><span class="p">,</span> <span class="n">xy_bounds</span><span class="o">=</span><span class="n">xy_bounds</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;V&quot;</span><span class="p">:</span>
        <span class="n">mod</span><span class="p">,</span> <span class="n">p_guess</span> <span class="o">=</span> <span class="n">make_models</span><span class="p">(</span>
            <span class="n">voigt2d</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lineshape</span><span class="o">=</span><span class="n">lineshape</span><span class="p">,</span> <span class="n">xy_bounds</span><span class="o">=</span><span class="n">xy_bounds</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;G_L&quot;</span><span class="p">:</span>
        <span class="n">mod</span><span class="p">,</span> <span class="n">p_guess</span> <span class="o">=</span> <span class="n">make_models</span><span class="p">(</span>
            <span class="n">gaussian_lorentzian</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lineshape</span><span class="o">=</span><span class="s2">&quot;PV&quot;</span><span class="p">,</span> <span class="n">xy_bounds</span><span class="o">=</span><span class="n">xy_bounds</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;PV_G&quot;</span><span class="p">:</span>
        <span class="n">mod</span><span class="p">,</span> <span class="n">p_guess</span> <span class="o">=</span> <span class="n">make_models</span><span class="p">(</span>
            <span class="n">pv_g</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lineshape</span><span class="o">=</span><span class="s2">&quot;PV&quot;</span><span class="p">,</span> <span class="n">xy_bounds</span><span class="o">=</span><span class="n">xy_bounds</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;PV_L&quot;</span><span class="p">:</span>
        <span class="n">mod</span><span class="p">,</span> <span class="n">p_guess</span> <span class="o">=</span> <span class="n">make_models</span><span class="p">(</span>
            <span class="n">pv_l</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lineshape</span><span class="o">=</span><span class="s2">&quot;PV&quot;</span><span class="p">,</span> <span class="n">xy_bounds</span><span class="o">=</span><span class="n">xy_bounds</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">lineshape</span> <span class="o">==</span> <span class="s2">&quot;PV_PV&quot;</span><span class="p">:</span>
        <span class="n">mod</span><span class="p">,</span> <span class="n">p_guess</span> <span class="o">=</span> <span class="n">make_models</span><span class="p">(</span>
            <span class="n">pv_pv</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lineshape</span><span class="o">=</span><span class="s2">&quot;PV_PV&quot;</span><span class="p">,</span> <span class="n">xy_bounds</span><span class="o">=</span><span class="n">xy_bounds</span>
        <span class="p">)</span>

    <span class="c1"># get initial peak centers</span>
    <span class="n">cen_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_guess</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p_guess</span> <span class="k">if</span> <span class="s2">&quot;center_x&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">cen_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_guess</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p_guess</span> <span class="k">if</span> <span class="s2">&quot;center_y&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">mask</span> <span class="o">+=</span> <span class="n">make_mask</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">peak</span><span class="o">.</span><span class="n">X_AXISf</span><span class="p">,</span> <span class="n">peak</span><span class="o">.</span><span class="n">Y_AXISf</span><span class="p">,</span> <span class="n">peak</span><span class="o">.</span><span class="n">X_RADIUS</span><span class="p">,</span> <span class="n">peak</span><span class="o">.</span><span class="n">Y_RADIUS</span>
        <span class="p">)</span>

    <span class="n">x_radius</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">X_RADIUS</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">y_radius</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">Y_RADIUS</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">max_x</span><span class="p">,</span> <span class="n">min_x</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">X_AXISf</span><span class="p">)</span> <span class="o">+</span> <span class="n">x_radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">X_AXISf</span><span class="p">)</span> <span class="o">-</span> <span class="n">x_radius</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">max_y</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">Y_AXISf</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">Y_AXISf</span><span class="p">)</span> <span class="o">-</span> <span class="n">y_radius</span><span class="p">)),</span>
    <span class="p">)</span>

    <span class="c1">#  deal with peaks on the edge of spectrum</span>
    <span class="k">if</span> <span class="n">min_y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">min_x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">min_x</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">max_y</span> <span class="o">&gt;</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">max_x</span> <span class="o">&gt;</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">peak_slices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">mask</span><span class="p">]</span>
    <span class="c1"># must be a better way to make the meshgrid</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">XY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">XY</span>

    <span class="n">XY_slices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">mask</span><span class="p">],</span> <span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">mask</span><span class="p">]])</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">noise</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">peak_slices</span><span class="p">)))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">peak_slices</span><span class="p">,</span> <span class="n">XY</span><span class="o">=</span><span class="n">XY_slices</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">p_guess</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">fit_method</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">fit_report</span><span class="p">())</span>

    <span class="n">z_sim</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">XY</span><span class="o">=</span><span class="n">XY</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="n">z_sim</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">z_plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">z_plot</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1">#  also if peak position changed significantly from start then add warning</span>

    <span class="n">_z_plot</span> <span class="o">=</span> <span class="n">z_plot</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z_plot</span><span class="p">)]</span>
    <span class="n">_z_sim</span> <span class="o">=</span> <span class="n">z_sim</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z_sim</span><span class="p">)]</span>

    <span class="n">linmod</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">()</span>
    <span class="n">linpars</span> <span class="o">=</span> <span class="n">linmod</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">_z_sim</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">_z_plot</span><span class="p">)</span>
    <span class="n">linfit</span> <span class="o">=</span> <span class="n">linmod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_z_sim</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">_z_plot</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">linpars</span><span class="p">)</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">linfit</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="c1">#  number of peaks in cluster</span>
    <span class="n">n_peaks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

    <span class="n">chi2</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">chisqr</span>
    <span class="n">redchi</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">redchi</span>

    <span class="n">fit_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Cluster </span><span class="si">{</span><span class="n">peak</span><span class="o">.</span><span class="n">CLUSTID</span><span class="si">}</span><span class="s2"> containing </span><span class="si">{</span><span class="n">n_peaks</span><span class="si">}</span><span class="s2"> peaks - slope=</span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"></span>

<span class="s2">        chi^2 = </span><span class="si">{</span><span class="n">chi2</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        redchi = </span><span class="si">{</span><span class="n">redchi</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"></span>

<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">slope</span> <span class="o">&gt;</span> <span class="mf">1.05</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">slope</span> <span class="o">&lt;</span> <span class="mf">0.95</span><span class="p">):</span>
        <span class="n">fit_str</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        🧐 NEEDS CHECKING 🧐</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fit_str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fit_str</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;#&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fit_str</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">FitResult</span><span class="p">(</span>
        <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
        <span class="n">fit_str</span><span class="o">=</span><span class="n">fit_str</span><span class="p">,</span>
        <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span>
        <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
        <span class="n">uc_dics</span><span class="o">=</span><span class="n">uc_dics</span><span class="p">,</span>
        <span class="n">min_x</span><span class="o">=</span><span class="n">min_x</span><span class="p">,</span>
        <span class="n">min_y</span><span class="o">=</span><span class="n">min_y</span><span class="p">,</span>
        <span class="n">max_x</span><span class="o">=</span><span class="n">max_x</span><span class="p">,</span>
        <span class="n">max_y</span><span class="o">=</span><span class="n">max_y</span><span class="p">,</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
        <span class="n">Y</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span>
        <span class="n">Z</span><span class="o">=</span><span class="n">z_plot</span><span class="p">,</span>
        <span class="n">Z_sim</span><span class="o">=</span><span class="n">z_sim</span><span class="p">,</span>
        <span class="n">peak_slices</span><span class="o">=</span><span class="n">peak_slices</span><span class="p">,</span>
        <span class="n">XY_slices</span><span class="o">=</span><span class="n">XY_slices</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="n">mod</span><span class="o">=</span><span class="n">mod</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="k">class</span> <span class="nc">FitResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Data structure for storing fit results &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">ModelResult</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">fit_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">log</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">group</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">groupby</span><span class="o">.</span><span class="n">generic</span><span class="o">.</span><span class="n">DataFrameGroupBy</span><span class="p">,</span>
        <span class="n">uc_dics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">min_x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">min_y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">max_x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">max_y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">Y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">Z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">Z_sim</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">peak_slices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">XY_slices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">mod</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store output of fit_first_plane function &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_str</span> <span class="o">=</span> <span class="n">fit_str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uc_dics</span> <span class="o">=</span> <span class="n">uc_dics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_x</span> <span class="o">=</span> <span class="n">min_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_y</span> <span class="o">=</span> <span class="n">min_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_x</span> <span class="o">=</span> <span class="n">max_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span> <span class="o">=</span> <span class="n">max_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z_sim</span> <span class="o">=</span> <span class="n">Z_sim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_slices</span> <span class="o">=</span> <span class="n">peak_slices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XY_slices</span> <span class="o">=</span> <span class="n">XY_slices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">mod</span>

    <span class="k">def</span> <span class="nf">check_shifts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate difference between initial peak positions </span>
<span class="sd">            and check whether they moved too much from original</span>
<span class="sd">            position</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">jackknife</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; perform jackknife sampling to estimate fitting errors</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jk_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_slices</span><span class="p">)):</span>
            <span class="n">peak_slices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_slices</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XY_slices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XY_slices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">jk_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                    <span class="n">peak_slices</span><span class="p">,</span> <span class="n">XY</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># print(jk_results)</span>
        <span class="n">amps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sigma_xs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sigma_ys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;test_jackknife&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">jk_results</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">fit_report</span><span class="p">())</span>
                <span class="n">amp</span><span class="p">,</span> <span class="n">amp_err</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">get_params</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;amp&quot;</span><span class="p">)</span>
                <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_x_err</span><span class="p">,</span> <span class="n">name_x</span> <span class="o">=</span> <span class="n">get_params</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;sigma_x&quot;</span><span class="p">)</span>
                <span class="n">sigma_y</span><span class="p">,</span> <span class="n">sigma_y_err</span><span class="p">,</span> <span class="n">name_y</span> <span class="o">=</span> <span class="n">get_params</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;sigma_y&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">amp</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">amp_err</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">name_y</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">amps</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>
                <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">name_y</span><span class="p">)</span>
                <span class="n">sigma_xs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">)</span>
                <span class="n">sigma_ys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sigma_y</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;amp&quot;</span><span class="p">:</span> <span class="n">amps</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span> <span class="s2">&quot;sigma_x&quot;</span><span class="p">:</span> <span class="n">sigma_xs</span><span class="p">,</span> <span class="s2">&quot;sigma_y&quot;</span><span class="p">:</span> <span class="n">sigma_ys</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">mean_amps</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">std_amps</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">mean_sigma_x</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">sigma_x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">std_sigma_x</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">sigma_x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">mean_sigma_y</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">sigma_y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">std_sigma_y</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">sigma_y</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#####################################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mean_amps</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">std_amps</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">mean_sigma_x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">std_sigma_x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">mean_sigma_y</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">std_sigma_y</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">fit_report</span><span class="p">())</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#####################################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># print(amps)</span>
        <span class="c1"># mean = np.mean(amps)</span>
        <span class="c1"># std =  np.std(amps)</span>
        <span class="k">return</span> <span class="n">JackKnifeResult</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean_amps</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std_amps</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nomp</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Matplotlib interactive plot of the fits &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">plot_path</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">plot_path</span><span class="p">)</span>
            <span class="n">plot_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># plotting</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>
            <span class="c1"># slice out plot area</span>
            <span class="n">x_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_dics</span><span class="p">[</span><span class="s2">&quot;f2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ppm</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">min_y</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_x</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_x</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">y_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_dics</span><span class="p">[</span><span class="s2">&quot;f1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ppm</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">min_y</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_x</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_x</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">z_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">min_y</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_x</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_x</span><span class="p">]</span>

            <span class="n">z_sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_sim</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">min_y</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_x</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_x</span><span class="p">]</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                <span class="s2">&quot;$\chi^2$=&quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">chisqr</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;$\chi_</span><span class="si">{red}</span><span class="s2">^2$=&quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">redchi</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">residual</span> <span class="o">=</span> <span class="n">z_plot</span> <span class="o">-</span> <span class="n">z_sim</span>
            <span class="n">cset</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
                <span class="n">x_plot</span><span class="p">,</span>
                <span class="n">y_plot</span><span class="p">,</span>
                <span class="n">residual</span><span class="p">,</span>
                <span class="n">zdir</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span>
                <span class="n">offset</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z_plot</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cset</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.2e</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># plot raw data</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot_wireframe</span><span class="p">(</span><span class="n">x_plot</span><span class="p">,</span> <span class="n">y_plot</span><span class="p">,</span> <span class="n">z_plot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#03353E&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;F2 ppm&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;F1 ppm&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot_wireframe</span><span class="p">(</span>
                <span class="n">x_plot</span><span class="p">,</span> <span class="n">y_plot</span><span class="p">,</span> <span class="n">z_sim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#C1403D&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fit&quot;</span>
            <span class="p">)</span>

            <span class="c1"># axes will appear inverted</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>

            <span class="c1"># Annotate plots</span>
            <span class="n">labs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Z_lab</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Y_lab</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">X_lab</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">valuesdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;amplitude&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">Z_lab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="c1"># get prefix</span>
                    <span class="n">labs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="s2">&quot;center_x&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">X_lab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uc_dics</span><span class="p">[</span><span class="s2">&quot;f2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ppm</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">elif</span> <span class="s2">&quot;center_y&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">Y_lab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uc_dics</span><span class="p">[</span><span class="s2">&quot;f1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ppm</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="c1">#  this is dumb as !£$@</span>
            <span class="c1"># Z_lab = [</span>
            <span class="c1">#    self.Z[</span>
            <span class="c1">#        int(round(self.uc_dics[&quot;f1&quot;](y, &quot;ppm&quot;))),</span>
            <span class="c1">#        int(round(self.uc_dics[&quot;f2&quot;](x, &quot;ppm&quot;))),</span>
            <span class="c1">#    ]</span>
            <span class="c1">#    for x, y in zip(X_lab, Y_lab)</span>
            <span class="c1"># ]</span>
            <span class="n">z_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_plot</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">Z_lab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Z_lab</span><span class="p">)</span>
            <span class="n">z_max</span> <span class="o">=</span> <span class="n">z_max</span> <span class="o">*</span> <span class="p">(</span><span class="n">Z_lab</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">Z_lab</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labs</span><span class="p">,</span> <span class="n">X_lab</span><span class="p">,</span> <span class="n">Y_lab</span><span class="p">,</span> <span class="n">z_max</span><span class="p">):</span>
                <span class="c1"># print(l, x, y, z)</span>
                <span class="c1"># ax.text(x, y, z * 1.2, l, None)</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="mf">1.2</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="c1"># plt.colorbar(contf)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">))</span>

            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">CLUSTID</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">show</span> <span class="ow">and</span> <span class="n">nomp</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

                <span class="k">def</span> <span class="nf">exit_program</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                    <span class="n">exit</span><span class="p">()</span>

                <span class="k">def</span> <span class="nf">next_plot</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="n">axexit</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.81</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">])</span>
                <span class="n">bnexit</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="n">axexit</span><span class="p">,</span> <span class="s2">&quot;Exit&quot;</span><span class="p">)</span>
                <span class="n">bnexit</span><span class="o">.</span><span class="n">on_clicked</span><span class="p">(</span><span class="n">exit_program</span><span class="p">)</span>

                <span class="n">axnext</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.71</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">])</span>
                <span class="n">bnnext</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="n">axnext</span><span class="p">,</span> <span class="s2">&quot;Next&quot;</span><span class="p">)</span>
                <span class="n">bnnext</span><span class="o">.</span><span class="n">on_clicked</span><span class="p">(</span><span class="n">next_plot</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="n">Fore</span><span class="o">.</span><span class="n">RED</span>
                    <span class="o">+</span> <span class="s2">&quot;Cannot use interactive matplotlib in multiprocess mode. Use --nomp flag.&quot;</span>
                <span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="c1">#    print(p_guess)</span>
            <span class="c1"># close plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>


<span class="k">class</span> <span class="nc">JackKnifeResult</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">std</span>


<div class="viewcode-block" id="Pseudo3D"><a class="viewcode-back" href="../../usage/code.html#peakipy.core.Pseudo3D">[docs]</a><span class="k">class</span> <span class="nc">Pseudo3D</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Read dic, data from NMRGlue and dims from input to create a Pseudo3D dataset</span>

<span class="sd">       :param dic: from nmrglue.pipe.read</span>
<span class="sd">       :type dic: dict</span>

<span class="sd">       :param data: data from nmrglue.pipe.read</span>
<span class="sd">       :type data: numpy.array</span>

<span class="sd">       :param dims: dimension order i.e [0,1,2] where 0 = planes, 1 = f1, 2 = f2</span>
<span class="sd">       :type dims: list</span>
<span class="sd">       &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dic</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dims</span><span class="p">):</span>
        <span class="c1"># check dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span> <span class="o">=</span> <span class="n">ng</span><span class="o">.</span><span class="n">pipe</span><span class="o">.</span><span class="n">guess_udic</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span><span class="p">[</span><span class="s2">&quot;ndim&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Fore</span><span class="o">.</span><span class="n">RED</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            ##########################################</span>
<span class="s2">                NMR Data should be either 2D or 3D</span>
<span class="s2">            ##########################################</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="c1"># raise TypeError(err)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="c1"># check that spectrum has correct number of dims</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndim</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Fore</span><span class="o">.</span><span class="n">RED</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            #################################################################</span>
<span class="s2">               Your spectrum has </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ndim</span><span class="si">}</span><span class="s2"> dimensions with shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"></span>
<span class="s2">               but you have given a dimension order of </span><span class="si">{</span><span class="n">dims</span><span class="si">}</span><span class="s2">...</span>
<span class="s2">            #################################################################</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="c1"># raise ValueError(err)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f1_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f2_dim</span> <span class="o">=</span> <span class="n">dims</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_planes</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uc_f1</span> <span class="o">=</span> <span class="n">ng</span><span class="o">.</span><span class="n">pipe</span><span class="o">.</span><span class="n">make_uc</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_f1_dim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uc_f2</span> <span class="o">=</span> <span class="n">ng</span><span class="o">.</span><span class="n">pipe</span><span class="o">.</span><span class="n">make_uc</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_f2_dim</span><span class="p">)</span>
            <span class="c1"># make data pseudo3d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_planes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f1_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f2_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_planes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f1_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f2_dim</span> <span class="o">=</span> <span class="n">dims</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span> <span class="o">=</span> <span class="n">dims</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="c1"># make unit conversion dicts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uc_f2</span> <span class="o">=</span> <span class="n">ng</span><span class="o">.</span><span class="n">pipe</span><span class="o">.</span><span class="n">make_uc</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_f2_dim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uc_f1</span> <span class="o">=</span> <span class="n">ng</span><span class="o">.</span><span class="n">pipe</span><span class="o">.</span><span class="n">make_uc</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_f1_dim</span><span class="p">)</span>

        <span class="c1">#  rearrange data if dims not in standard order</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="c1"># np.argsort returns indices of array for order 0,1,2 to transpose data correctly</span>
            <span class="c1"># self._dims = np.argsort(self._dims)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dic</span> <span class="o">=</span> <span class="n">dic</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_f1_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_f1_dim</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f2_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_f2_dim</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uc_f1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return unit conversion dict for F1&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uc_f1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uc_f2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return unit conversion dict for F2&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uc_f2</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return dimension order &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dims</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return array containing data &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="nd">@data</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dic</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">udic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ndim</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f1_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># dim label</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f1_label</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f2_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># dim label</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f2_label</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">planes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_planes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># size of f1 and f2 in points</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f2_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return size of f2 dimension in points &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_f2_dim</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f1_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return size of f1 dimension in points &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_f1_dim</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>

    <span class="c1"># points per ppm</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pt_per_ppm_f1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f1_size</span> <span class="o">/</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_f1_dim</span><span class="p">][</span><span class="s2">&quot;sw&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_f1_dim</span><span class="p">][</span><span class="s2">&quot;obs&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pt_per_ppm_f2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f2_size</span> <span class="o">/</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_f2_dim</span><span class="p">][</span><span class="s2">&quot;sw&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_f2_dim</span><span class="p">][</span><span class="s2">&quot;obs&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># points per hz</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pt_per_hz_f1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f1_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_f1_dim</span><span class="p">][</span><span class="s2">&quot;sw&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pt_per_hz_f2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f2_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_udic</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_f2_dim</span><span class="p">][</span><span class="s2">&quot;sw&quot;</span><span class="p">]</span>

    <span class="c1"># hz per point</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hz_per_pt_f1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_hz_f1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hz_per_pt_f2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_hz_f2</span>

    <span class="c1"># ppm per point</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ppm_per_pt_f1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_ppm_f1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ppm_per_pt_f2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_ppm_f2</span>

    <span class="c1"># get ppm limits for ppm scales</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f2_ppm_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_f2</span><span class="o">.</span><span class="n">ppm_scale</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f1_ppm_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_f1</span><span class="o">.</span><span class="n">ppm_scale</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f2_ppm_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_f2</span><span class="o">.</span><span class="n">ppm_limits</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f1_ppm_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_f1</span><span class="o">.</span><span class="n">ppm_limits</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f1_ppm_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f1_ppm_limits</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f1_ppm_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f1_ppm_limits</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f2_ppm_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f2_ppm_limits</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f2_ppm_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f2_ppm_limits</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f2_ppm_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f2_ppm_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f2_ppm_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f2_ppm_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f1_ppm_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f1_ppm_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f1_ppm_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f1_ppm_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>


<span class="k">class</span> <span class="nc">Peaklist</span><span class="p">(</span><span class="n">Pseudo3D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read analysis, sparky or NMRPipe peak list and convert to NMRPipe-ish format also find peak clusters</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : path-like or str</span>
<span class="sd">        path to peaklist</span>
<span class="sd">    data_path : ndarray</span>
<span class="sd">        NMRPipe format data</span>
<span class="sd">    fmt : a2|sparky|pipe</span>
<span class="sd">    dims: [planes,y,x]</span>
<span class="sd">    radii: [x,y]</span>
<span class="sd">        Mask radii in ppm</span>


<span class="sd">    Methods</span>
<span class="sd">    -------</span>

<span class="sd">    clusters :</span>
<span class="sd">    mask_method :</span>
<span class="sd">    adaptive_clusters :</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas DataFrame</span>
<span class="sd">        dataframe containing peaklist</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">,</span>
        <span class="n">data_path</span><span class="p">,</span>
        <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;a2&quot;</span><span class="p">,</span>
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">radii</span><span class="o">=</span><span class="p">[</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
        <span class="n">posF1</span><span class="o">=</span><span class="s2">&quot;Position F2&quot;</span><span class="p">,</span>
        <span class="n">posF2</span><span class="o">=</span><span class="s2">&quot;Position F1&quot;</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">dic</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">ng</span><span class="o">.</span><span class="n">pipe</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
        <span class="n">Pseudo3D</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dic</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peaklist_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">data_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_radii</span> <span class="o">=</span> <span class="n">radii</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thres</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Points per hz f1 = </span><span class="si">%.3f</span><span class="s2">, f2 = </span><span class="si">%.3f</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pt_per_hz_f1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_hz_f2</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_to_pipe_dic</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;#&quot;</span><span class="p">:</span> <span class="s2">&quot;INDEX&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;&quot;: &quot;X_AXIS&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;Y_AXIS&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;DX&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;DY&quot;,</span>
            <span class="s2">&quot;Position F1&quot;</span><span class="p">:</span> <span class="s2">&quot;X_PPM&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Position F2&quot;</span><span class="p">:</span> <span class="s2">&quot;Y_PPM&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;&quot;: &quot;X_HZ&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;Y_HZ&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;XW&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;YW&quot;,</span>
            <span class="s2">&quot;Line Width F1 (Hz)&quot;</span><span class="p">:</span> <span class="s2">&quot;XW_HZ&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Line Width F2 (Hz)&quot;</span><span class="p">:</span> <span class="s2">&quot;YW_HZ&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;&quot;: &quot;X1&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;X3&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;Y1&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;Y3&quot;,</span>
            <span class="s2">&quot;Height&quot;</span><span class="p">:</span> <span class="s2">&quot;HEIGHT&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;Height&quot;: &quot;DHEIGHT&quot;,</span>
            <span class="s2">&quot;Volume&quot;</span><span class="p">:</span> <span class="s2">&quot;VOL&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;&quot;: &quot;PCHI2&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;TYPE&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;ASS&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;CLUSTID&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;MEMCNT&quot;</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sparky_to_pipe_dic</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;INDEX&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;&quot;: &quot;X_AXIS&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;Y_AXIS&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;DX&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;DY&quot;,</span>
            <span class="s2">&quot;w1&quot;</span><span class="p">:</span> <span class="s2">&quot;X_PPM&quot;</span><span class="p">,</span>
            <span class="s2">&quot;w2&quot;</span><span class="p">:</span> <span class="s2">&quot;Y_PPM&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;&quot;: &quot;X_HZ&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;Y_HZ&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;XW&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;YW&quot;,</span>
            <span class="s2">&quot;lw1 (hz)&quot;</span><span class="p">:</span> <span class="s2">&quot;XW_HZ&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lw2 (hz)&quot;</span><span class="p">:</span> <span class="s2">&quot;YW_HZ&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;&quot;: &quot;X1&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;X3&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;Y1&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;Y3&quot;,</span>
            <span class="s2">&quot;Height&quot;</span><span class="p">:</span> <span class="s2">&quot;HEIGHT&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;Height&quot;: &quot;DHEIGHT&quot;,</span>
            <span class="s2">&quot;Volume&quot;</span><span class="p">:</span> <span class="s2">&quot;VOL&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;&quot;: &quot;PCHI2&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;TYPE&quot;,</span>
            <span class="s2">&quot;Assignment&quot;</span><span class="p">:</span> <span class="s2">&quot;ASS&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;&quot;: &quot;CLUSTID&quot;,</span>
            <span class="c1"># &quot;&quot;: &quot;MEMCNT&quot;</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_to_pipe_dic</span><span class="p">[</span><span class="n">posF1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Y_PPM&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_to_pipe_dic</span><span class="p">[</span><span class="n">posF2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;X_PPM&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_peaklist</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read_peaklist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;a2&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_analysis</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;sparky&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_sparky</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;pipe&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_pipe</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;I don&#39;t know this format&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>

    <span class="nd">@df</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">radii</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radii</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f2_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; radius for fitting mask in f2 &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">f1_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; radius for fitting mask in f1 &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">analysis_to_pipe_dic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_to_pipe_dic</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sparky_to_pipe_dic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sparky_to_pipe_dic</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">thres</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thres</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thres</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">threshold_otsu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thres</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thres</span>

    <span class="k">def</span> <span class="nf">update_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># int point value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;X_AXIS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">X_PPM</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_f2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;ppm&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_AXIS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Y_PPM</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_f1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;ppm&quot;</span><span class="p">))</span>
        <span class="c1"># decimal point value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;X_AXISf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">X_PPM</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_f2</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;ppm&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_AXISf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Y_PPM</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_f1</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;ppm&quot;</span><span class="p">))</span>
        <span class="c1"># in case of missing values (should estimate though)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">XW_HZ</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;20.0&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">YW_HZ</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;20.0&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">XW_HZ</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="s2">&quot;20.0&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">YW_HZ</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="s2">&quot;20.0&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># convert linewidths to float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;XW_HZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">XW_HZ</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;YW_HZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">YW_HZ</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="c1"># convert Hz lw to points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;XW&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">XW_HZ</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_hz_f2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;YW&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">YW_HZ</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_hz_f1</span><span class="p">)</span>
        <span class="c1"># makes an assignment column</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;a2&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;ASS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;Assign F1&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;Assign F2&quot;</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

        <span class="c1"># make default values for X and Y radii for fit masks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;X_RADIUS_PPM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">f2_radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_RADIUS_PPM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">f1_radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;X_RADIUS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">X_RADIUS_PPM</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_ppm_f2</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_RADIUS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Y_RADIUS_PPM</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_ppm_f1</span>
        <span class="p">)</span>
        <span class="c1"># add include column</span>
        <span class="k">if</span> <span class="s2">&quot;include&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># check assignments for duplicates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_assignments</span><span class="p">()</span>
        <span class="c1"># check that peaks are within the bounds of the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_peak_bounds</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_fix_bound_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; add columns containing parameter bounds (param_upper/param_lower)</span>
<span class="sd">            and whether or not parameter should be fixed (yes/no)</span>

<span class="sd">            For parameter bounding:</span>

<span class="sd">                Column names are &lt;param_name&gt;_upper and &lt;param_name&gt;_lower for upper and lower bounds respectively.</span>
<span class="sd">                Values are given as floating point. Value of 0.0 indicates that parameter is unbounded</span>
<span class="sd">                X/Y positions are given in ppm</span>
<span class="sd">                Linewidths are given in Hz</span>

<span class="sd">            For parameter fixing:</span>

<span class="sd">                Column names are &lt;param_name&gt;_fix.</span>
<span class="sd">                Values are given as a string &#39;yes&#39; or &#39;no&#39;</span>

<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_read_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peaklist_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">new_columns</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_to_pipe_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">pipe_columns</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">new_columns</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">pipe_columns</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_read_sparky</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peaklist_path</span><span class="p">,</span>
            <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ASS&quot;</span><span class="p">,</span> <span class="s2">&quot;Y_PPM&quot;</span><span class="p">,</span> <span class="s2">&quot;X_PPM&quot;</span><span class="p">,</span> <span class="s2">&quot;VOLUME&quot;</span><span class="p">,</span> <span class="s2">&quot;HEIGHT&quot;</span><span class="p">,</span> <span class="s2">&quot;YW_HZ&quot;</span><span class="p">,</span> <span class="s2">&quot;XW_HZ&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;INDEX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_read_pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">to_skip</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peaklist_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;VARS&quot;</span><span class="p">):</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">elif</span> <span class="n">line</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">to_skip</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peaklist_path</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="n">to_skip</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">check_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;ASS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">ASS</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">duplicates_bool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">ASS</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">ASS</span><span class="p">[</span><span class="n">duplicates_bool</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                #############################################################################</span>
<span class="sd">                    You have duplicated assignments in your list...</span>
<span class="sd">                    Currently each peak needs a unique assignment. Sorry about that buddy...</span>
<span class="sd">                #############################################################################</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">duplicates_bool</span><span class="p">,</span> <span class="s2">&quot;ASS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_dummy_</span><span class="si">{</span><span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Here are the duplicates&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">ASS</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Creating dummy assignments for duplicates</span>
<span class="sd">                </span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_peak_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># check that peaks are within the bounds of spectrum</span>
        <span class="n">within_x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">X_PPM</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">f2_ppm_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">X_PPM</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">f2_ppm_min</span><span class="p">)</span>
        <span class="n">within_y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Y_PPM</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">f1_ppm_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Y_PPM</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">f1_ppm_min</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">excluded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">within_x</span> <span class="o">&amp;</span> <span class="n">within_y</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">within_x</span> <span class="o">&amp;</span> <span class="n">within_y</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">excluded</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">Fore</span><span class="o">.</span><span class="n">RED</span>
                <span class="o">+</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    #################################################################################</span>

<span class="s2">                    Excluding the following peaks as they are not within the spectrum which has shape </span>

<span class="s2">                    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">Fore</span><span class="o">.</span><span class="n">RED</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="si">{</span><span class="n">tabulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">excluded</span><span class="p">[[</span><span class="s2">&quot;INDEX&quot;</span><span class="p">,</span><span class="s2">&quot;ASS&quot;</span><span class="p">,</span><span class="s2">&quot;X_AXIS&quot;</span><span class="p">,</span><span class="s2">&quot;Y_AXIS&quot;</span><span class="p">,</span><span class="s2">&quot;X_PPM&quot;</span><span class="p">,</span><span class="s2">&quot;Y_PPM&quot;</span><span class="p">]],</span><span class="n">headers</span><span class="o">=</span><span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;fancy_grid&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">Fore</span><span class="o">.</span><span class="n">RED</span>
                <span class="o">+</span> <span class="s2">&quot;#################################################################################&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">struc_el</span><span class="o">=</span><span class="s2">&quot;disk&quot;</span><span class="p">,</span> <span class="n">struc_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">l_struc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Find clusters of peaks</span>

<span class="sd">        :param thres: threshold for positive signals above which clusters are selected. If None then threshold_otsu is used</span>
<span class="sd">        :type thres: float</span>

<span class="sd">        :param struc_el: &#39;square&#39;|&#39;disk&#39;|&#39;rectangle&#39;</span>
<span class="sd">            structuring element for binary_closing of thresholded data can be square, disc or rectangle</span>
<span class="sd">        :type struc_el: str</span>

<span class="sd">        :param struc_size: size/dimensions of structuring element</span>
<span class="sd">            for square and disk first element of tuple is used (for disk value corresponds to radius)</span>
<span class="sd">            for rectangle, tuple corresponds to (width,height).</span>
<span class="sd">        :type struc_size: tuple</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Y_AXIS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">X_AXIS</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">thres</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">thres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thres</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thres</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">threshold_otsu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thres</span> <span class="o">=</span> <span class="n">thres</span>

        <span class="c1"># get positive and negative</span>
        <span class="n">thresh_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thres</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thres</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">struc_el</span> <span class="o">==</span> <span class="s2">&quot;disk&quot;</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">struc_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using disk with </span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">closed_data</span> <span class="o">=</span> <span class="n">binary_closing</span><span class="p">(</span><span class="n">thresh_data</span><span class="p">,</span> <span class="n">disk</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">radius</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="n">struc_el</span> <span class="o">==</span> <span class="s2">&quot;square&quot;</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">struc_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using square with </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">closed_data</span> <span class="o">=</span> <span class="n">binary_closing</span><span class="p">(</span><span class="n">thresh_data</span><span class="p">,</span> <span class="n">square</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="n">struc_el</span> <span class="o">==</span> <span class="s2">&quot;rectangle&quot;</span><span class="p">:</span>
            <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">struc_size</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using rectangle with </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">closed_data</span> <span class="o">=</span> <span class="n">binary_closing</span><span class="p">(</span>
                <span class="n">thresh_data</span><span class="p">,</span> <span class="n">rectangle</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not using any closing function&quot;</span><span class="p">)</span>
            <span class="n">closed_data</span> <span class="o">=</span> <span class="n">thresh_data</span>

        <span class="n">labeled_array</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">closed_data</span><span class="p">,</span> <span class="n">l_struc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;CLUSTID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">labeled_array</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">]</span>

        <span class="c1">#  renumber &quot;0&quot; clusters</span>
        <span class="n">max_clustid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;CLUSTID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">n_of_zeros</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;CLUSTID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][</span><span class="s2">&quot;CLUSTID&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;CLUSTID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;CLUSTID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="n">max_clustid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_of_zeros</span> <span class="o">+</span> <span class="n">max_clustid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span>
        <span class="p">)</span>

        <span class="c1"># count how many peaks per cluster</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;CLUSTID&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;MEMCNT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Category20</span><span class="p">[</span><span class="mi">20</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">CLUSTID</span><span class="p">)</span> <span class="o">%</span> <span class="mi">20</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">MEMCNT</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ClustersResult</span><span class="p">(</span><span class="n">labeled_array</span><span class="p">,</span> <span class="n">num_features</span><span class="p">,</span> <span class="n">closed_data</span><span class="p">,</span> <span class="n">peaks</span><span class="p">)</span>

    <span class="c1"># def adaptive_clusters(self, block_size, offset, l_struc=None):</span>

    <span class="c1">#     self.thresh = threshold_otsu(self.data[0])</span>

    <span class="c1">#     peaks = [[y, x] for y, x in zip(self.df.Y_AXIS, self.df.X_AXIS)]</span>

    <span class="c1">#     binary_adaptive = threshold_adaptive(</span>
    <span class="c1">#         self.data[0], block_size=block_size, offset=offset</span>
    <span class="c1">#     )</span>

    <span class="c1">#     labeled_array, num_features = ndimage.label(binary_adaptive, l_struc)</span>
    <span class="c1">#     # print(labeled_array, num_features)</span>

    <span class="c1">#     self.df[&quot;CLUSTID&quot;] = [labeled_array[i[0], i[1]] for i in peaks]</span>

    <span class="c1">#     #  renumber &quot;0&quot; clusters</span>
    <span class="c1">#     max_clustid = self.df[&quot;CLUSTID&quot;].max()</span>
    <span class="c1">#     n_of_zeros = len(self.df[self.df[&quot;CLUSTID&quot;] == 0][&quot;CLUSTID&quot;])</span>
    <span class="c1">#     self.df.loc[self.df[self.df[&quot;CLUSTID&quot;] == 0].index, &quot;CLUSTID&quot;] = np.arange(</span>
    <span class="c1">#         max_clustid + 1, n_of_zeros + max_clustid + 1, dtype=int</span>
    <span class="c1">#     )</span>

    <span class="k">def</span> <span class="nf">mask_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">l_struc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; connect clusters based on overlap of fitting masks</span>

<span class="sd">            :param overlap: fraction of mask for which overlaps are calculated</span>
<span class="sd">            :type overlap: float</span>

<span class="sd">            :returns ClusterResult: Instance of ClusterResult</span>
<span class="sd">            :rtype: ClustersResult</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># overlap is positive</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_thres</span> <span class="o">=</span> <span class="n">threshold_otsu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">peak</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">mask</span> <span class="o">+=</span> <span class="n">make_mask</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">peak</span><span class="o">.</span><span class="n">X_AXISf</span><span class="p">,</span>
                <span class="n">peak</span><span class="o">.</span><span class="n">Y_AXISf</span><span class="p">,</span>
                <span class="n">peak</span><span class="o">.</span><span class="n">X_RADIUS</span> <span class="o">*</span> <span class="n">overlap</span><span class="p">,</span>
                <span class="n">peak</span><span class="o">.</span><span class="n">Y_RADIUS</span> <span class="o">*</span> <span class="n">overlap</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Y_AXIS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">X_AXIS</span><span class="p">)]</span>
        <span class="n">labeled_array</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">l_struc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;CLUSTID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">labeled_array</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">]</span>

        <span class="c1">#  renumber &quot;0&quot; clusters</span>
        <span class="n">max_clustid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;CLUSTID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">n_of_zeros</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;CLUSTID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][</span><span class="s2">&quot;CLUSTID&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;CLUSTID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;CLUSTID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="n">max_clustid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_of_zeros</span> <span class="o">+</span> <span class="n">max_clustid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span>
        <span class="p">)</span>

        <span class="c1"># count how many peaks per cluster</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;CLUSTID&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;MEMCNT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Category20</span><span class="p">[</span><span class="mi">20</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">CLUSTID</span><span class="p">)</span> <span class="o">%</span> <span class="mi">20</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">MEMCNT</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ClustersResult</span><span class="p">(</span><span class="n">labeled_array</span><span class="p">,</span> <span class="n">num_features</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">peaks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_fuda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;params.fuda&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;peaks.fuda&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">peaks_fuda</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ass</span><span class="p">,</span> <span class="n">f1_ppm</span><span class="p">,</span> <span class="n">f2_ppm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">ASS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Y_PPM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">X_PPM</span><span class="p">):</span>
                <span class="n">peaks_fuda</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ass</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">f1_ppm</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">f2_ppm</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;CLUSTID&quot;</span><span class="p">)</span>
        <span class="n">fuda_params</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">overlap_peaks</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">overlap_peaks_str</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">ASS</span><span class="p">)</span>
                <span class="n">overlap_peaks</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;OVERLAP_PEAKS=(</span><span class="si">{</span><span class="n">overlap_peaks_str</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">fuda_file</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">            </span>
<span class="s2"># Read peaklist and spectrum info</span>
<span class="s2">PEAKLIST=peaks.fuda</span>
<span class="s2">SPECFILE=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="si">}</span><span class="s2"></span>
<span class="s2">PARAMETERFILE=(bruker;vclist)</span>
<span class="s2">ZCORR=ncyc</span>
<span class="s2">NOISE=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">thres</span><span class="si">}</span><span class="s2"> # you&#39;ll need to adjust this</span>
<span class="s2">BASELINE=N</span>
<span class="s2">VERBOSELEVEL=5</span>
<span class="s2">PRINTDATA=Y</span>
<span class="s2">LM=(MAXFEV=250;TOL=1e-5)</span>
<span class="s2">#Specify the default values. All values are in ppm:</span>
<span class="s2">DEF_LINEWIDTH_F1=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f1_radius</span><span class="si">}</span><span class="s2"></span>
<span class="s2">DEF_LINEWIDTH_F2=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f2_radius</span><span class="si">}</span><span class="s2"></span>
<span class="s2">DEF_RADIUS_F1=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f1_radius</span><span class="si">}</span><span class="s2"></span>
<span class="s2">DEF_RADIUS_F2=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f2_radius</span><span class="si">}</span><span class="s2"></span>
<span class="s2">SHAPE=GLORE</span>
<span class="s2"># OVERLAP PEAKS</span>
<span class="si">{</span><span class="n">overlap_peaks</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fuda_params</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing FuDA file </span><span class="si">{</span><span class="n">fuda_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fuda_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">overlap_peaks</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ClustersResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Class to store results of clusters function &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labeled_array</span><span class="p">,</span> <span class="n">num_features</span><span class="p">,</span> <span class="n">closed_data</span><span class="p">,</span> <span class="n">peaks</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labeled_array</span> <span class="o">=</span> <span class="n">labeled_array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_features</span> <span class="o">=</span> <span class="n">num_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed_data</span> <span class="o">=</span> <span class="n">closed_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peaks</span> <span class="o">=</span> <span class="n">peaks</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labeled_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labeled_array</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_features</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peaks</span>


<span class="k">class</span> <span class="nc">LoadData</span><span class="p">(</span><span class="n">Peaklist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Load peaklist data from peakipy .csv file output from either peakipy read or edit</span>

<span class="sd">        read_peaklist is redefined to just read a .csv file</span>

<span class="sd">        check_data_frame makes sure data frame is in good shape for setting up fits</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">read_peaklist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaklist_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peaklist_path</span><span class="p">)</span>  <span class="c1"># , comment=&quot;#&quot;)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaklist_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.tab&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peaklist_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># comment=&quot;#&quot;)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peaklist_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_thres</span> <span class="o">=</span> <span class="n">threshold_otsu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>

    <span class="k">def</span> <span class="nf">check_data_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># make diameter columns</span>
        <span class="k">if</span> <span class="s2">&quot;X_DIAMETER_PPM&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;X_DIAMETER_PPM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;X_RADIUS_PPM&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_DIAMETER_PPM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_RADIUS_PPM&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span>

        <span class="c1">#  make a column to track edited peaks</span>
        <span class="k">if</span> <span class="s2">&quot;Edited&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Edited&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># create include column if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="s2">&quot;include&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># color clusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Category20</span><span class="p">[</span><span class="mi">20</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">CLUSTID</span><span class="p">)</span> <span class="o">%</span> <span class="mi">20</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">MEMCNT</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># get rid of unnamed columns</span>
        <span class="n">unnamed_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;Unnamed:&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">unnamed_cols</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Slightly modified to retain previous configurations &quot;&quot;&quot;</span>
        <span class="c1"># int point value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;X_AXIS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">X_PPM</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_f2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;ppm&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_AXIS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Y_PPM</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_f1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;ppm&quot;</span><span class="p">))</span>
        <span class="c1"># decimal point value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;X_AXISf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">X_PPM</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_f2</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;ppm&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_AXISf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Y_PPM</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uc_f1</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;ppm&quot;</span><span class="p">))</span>
        <span class="c1"># in case of missing values (should estimate though)</span>
        <span class="c1"># self.df.XW_HZ.replace(&quot;None&quot;, &quot;20.0&quot;, inplace=True)</span>
        <span class="c1"># self.df.YW_HZ.replace(&quot;None&quot;, &quot;20.0&quot;, inplace=True)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">XW_HZ</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="s2">&quot;20.0&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">YW_HZ</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="s2">&quot;20.0&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># convert linewidths to float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;XW_HZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">XW_HZ</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;YW_HZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">YW_HZ</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="c1"># convert Hz lw to points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;XW&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">XW_HZ</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_hz_f2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;YW&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">YW_HZ</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_hz_f1</span><span class="p">)</span>
        <span class="c1"># makes an assignment column</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;a2&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;ASS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;Assign F1&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;Assign F2&quot;</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

        <span class="c1"># make default values for X and Y radii for fit masks</span>
        <span class="c1"># self.df[&quot;X_RADIUS_PPM&quot;] = np.zeros(len(self.df)) + self.f2_radius</span>
        <span class="c1"># self.df[&quot;Y_RADIUS_PPM&quot;] = np.zeros(len(self.df)) + self.f1_radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;X_RADIUS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">X_RADIUS_PPM</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_ppm_f2</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_RADIUS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">Y_RADIUS_PPM</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_per_ppm_f1</span>
        <span class="p">)</span>
        <span class="c1"># add include column</span>
        <span class="k">if</span> <span class="s2">&quot;include&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;include&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># check assignments for duplicates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_assignments</span><span class="p">()</span>
        <span class="c1"># check that peaks are within the bounds of the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_peak_bounds</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">read_config</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="s2">&quot;peakipy.config&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; read a peakipy config file, extract params and update args dict</span>

<span class="sd">        :param args: dict containing params extracted from docopt command line</span>
<span class="sd">        :type args: dict</span>
<span class="sd">        :param config_path: path to peakipy config file [default: peakipy.config]</span>
<span class="sd">        :type config_path: str</span>

<span class="sd">        :returns args: updated args dict</span>
<span class="sd">        :rtype args: dict</span>
<span class="sd">        :returns config: dict that resulted from reading config file</span>
<span class="sd">        :rtype config: dict</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># update args with values from peakipy.config file</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Using config file with --dims=</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;--dims&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;--dims&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;--dims&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;noise&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">noise</span><span class="p">:</span>
                <span class="n">noise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span>

            <span class="n">colors</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;--colors&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;#5e3c99&quot;</span><span class="p">,</span> <span class="s2">&quot;#e66101&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">Fore</span><span class="o">.</span><span class="n">RED</span>
                <span class="o">+</span> <span class="s2">&quot;Your peakipy.config file is corrupted - maybe your JSON is not correct...&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s2">&quot;Not using&quot;</span><span class="p">)</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;--colors&quot;</span><span class="p">,</span> <span class="s2">&quot;#5e3c99,#e66101&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">Fore</span><span class="o">.</span><span class="n">RED</span>
            <span class="o">+</span> <span class="s2">&quot;No peakipy.config found - maybe you need to generate one with peakipy read or see docs&quot;</span>
        <span class="p">)</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;--colors&quot;</span><span class="p">,</span> <span class="s2">&quot;#5e3c99,#e66101&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">args</span><span class="p">[</span><span class="s2">&quot;noise&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise</span>
    <span class="n">args</span><span class="p">[</span><span class="s2">&quot;colors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span>

    <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">config</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo.png" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=j-brady&repo=peakipy&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage/installation.html">How to install peakipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/quickstart.html">Quickstart instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/instructions.html">Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/lineshapes.html">Lineshapes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/code.html">Code</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Jacob Peter Brady.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>